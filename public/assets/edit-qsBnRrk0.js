import{az as S,n as x,c as y,h as _,l as p}from"./index-C9fJEsZT.js";import"./index-TjCxX7sJ.js";import{h as d}from"./http-B5vhwVWP.js";import{e as v}from"./emitter-E5P-NQ8u.js";const c={async list(t="task",e=null){const i=`/api/conversation?${new URLSearchParams({mode_type:t,agent_id:e}).toString()}`;return await d.get(i)||{}},async create(t,e="task",n=null,i=null){return await d.post("/api/conversation",{content:t,mode_type:e,agent_id:n,model_id:i})||{}},async update(t,e=""){const n=`/api/conversation/${t}`;return await d.put(n,{title:e})||{}},async get(t){const e=`/api/conversation/${t}`;return await d.get(e)||{}},async remove(t){const e=`/api/conversation/${t}`;return await d.del(e)||{}},async query(t){return await d.post("/api/conversation/query",{query:t})||{}},async favorite(t){return await d.post("/api/conversation/favorite",{conversation_id:t})||{}},async unfavorite(t){return await d.post("/api/conversation/unfavorite",{conversation_id:t})||{}},async messageList(t){const e=`/api/message/list?conversation_id=${t}`;return await d.get(e)||{}},async stop(t){return await d.post("/api/agent/stop",{conversation_id:t})||{}}},l=[];for(let t=0;t<256;++t)l.push((t+256).toString(16).slice(1));function k(t,e=0){return(l[t[e+0]]+l[t[e+1]]+l[t[e+2]]+l[t[e+3]]+"-"+l[t[e+4]]+l[t[e+5]]+"-"+l[t[e+6]]+l[t[e+7]]+"-"+l[t[e+8]]+l[t[e+9]]+"-"+l[t[e+10]]+l[t[e+11]]+l[t[e+12]]+l[t[e+13]]+l[t[e+14]]+l[t[e+15]]).toLowerCase()}let f;const T=new Uint8Array(16);function M(){if(!f){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");f=crypto.getRandomValues.bind(crypto)}return f(T)}const $=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),g={randomUUID:$};function j(t,e,n){var s;if(g.randomUUID&&!e&&!t)return g.randomUUID();t=t||{};const i=t.random??((s=t.rng)==null?void 0:s.call(t))??M();if(i.length<16)throw new Error("Random bytes length must be >= 16");if(i[6]=i[6]&15|64,i[8]=i[8]&63|128,e){if(n=n||0,n<0||n+16>e.length)throw new RangeError(`UUID byte range ${n}:${n+15} is out of buffer bounds`);for(let o=0;o<16;++o)e[n+o]=i[o];return e}return k(i)}let m="running";function C(t,e){if(t.meta&&typeof t.meta=="string"&&(t.meta=JSON.parse(t.meta)),t.meta.action_type=="")return;if(!t.meta||!t.meta.action_type)return e.push(t);const{action_type:n}=t.meta;if(console.log("handleMessage",t),!(m=="stop"&&n!="question"&&n!="auto_reply"))switch(n){case"chat":return L(t,e);case"auto_reply":return m="running",U(t,e);case"plan":return D(t,e);case"question":return m="running",R(t,e);case"finish_summery":case"progress":case"coding":return B(t,e);case"stop":return w(t,e);case"error":return w(t,e);case"finish":return;case"task":return E(t,e);default:return N(t,e)}}function w(t,e){var n;e.push(t),console.log("handleStop",e);for(let i=e.length-1;i>=0;i--)((n=e[i].meta)==null?void 0:n.action_type)==="update_status"&&e.splice(i,1);e.forEach(i=>{var s;return((s=i.meta)==null?void 0:s.action_type)==="plan"&&Array.isArray(i.meta.json)&&i.meta.json.forEach(o=>{o.status=="running"&&(o.status="success");let a=o.actions;(a==null?void 0:a.length)>0&&a.forEach(r=>{r.status=="running"&&(r.status="success")})}),i})}function B(t,e){let n=t.meta.json;for(let i=0;i<n.length;i++){const s=n[i];s.id=j()}e.push(t)}function b(t){//!message.is_temp && message.meta.action_type !== "update_status" 删除
var e;for(let n=t.length-1;n>=0;n--){const i=t[n];((e=i==null?void 0:i.meta)==null?void 0:e.action_type)=="update_status"&&t.splice(n,1)}}function D(t,e){b(e),console.log("plan",t),t.meta.json.forEach(n=>{n.is_collapse=!0}),t.meta.json[0].status="running",e.push(t)}function U(t,e){e.push(t),e.push({content:S.global.t("lemon.message.botInitialPlan"),role:"assistant",is_temp:!0,meta:{action_type:"update_status"}})}function L(t,e){console.log("handleChatMessage",t),e.push(t)}function R(t,e){console.log("handleQuestion",t);let n=e.findLastIndex(i=>i.role==="user"&&i.is_temp);n!==-1?(e[n]=t,e[n].files=t.meta.json):e.push(t)}function E(t,e){const n=t.meta.task_id;let i=e.findLastIndex(a=>a.meta&&a.meta.action_type==="plan"),s=e[i],o=s.meta.json.findIndex(a=>a.id===n);if(o!==-1){s.meta.json[o].status=t.meta.json.status||t.status,s.meta.json[o].meta=t.meta;let a=t.meta.json.status||t.status;if(a==="failure"){let r=s.meta.json[o].actions||[];r=r.filter(u=>u.status!=="running"),s.meta.json[o].actions=r}(a==="success"||a==="completed")&&s.meta.json[o+1]&&(s.meta.json[o+1].status="running")}}function N(t,e){const n=t.meta.task_id,i=t.uuid;t.meta.action_type==="terminal_run"&&(t.content=[t.content]);let s=e.findLastIndex(h=>h.meta&&h.meta.action_type==="plan"),o=e[s],a=o.meta.json.findIndex(h=>h.id===n);a===-1&&(a=o.meta.json.findIndex(h=>h.status==="running"),a===-1&&(a=Math.max(0,o.meta.json.length-1))),o.meta.json[a].actions||(o.meta.json[a].actions=[]);let r=o.meta.json[a].actions,u=r.findIndex(h=>h.uuid===i);u!==-1?(r[u].status=t.status,r[u].meta=t.meta,console.log("message.action_type",t.meta.action_type),t.meta.action_type==="terminal_run"&&(r[u].content=[r[u].content[0],t.content[0]]),t.meta.action_type==="mcp_tool"&&(r[u].meta.content=t.content)):r.push(t)}const I={handleMessage:C},V=void 0,Q=x("chat",{state:()=>({list:[],chat:{},messages:[],events:[],agent:{},status:"done",conversationId:null,socket:null,baseUrl:V,commands:[],isScrolledToBottom:!0,updateTitle:!0,stopReplay:!1,replayStatus:"done",mode:"task",mode_editor:!1,model_id:"",chatInfo:{pid:-1,msgList:[],cursorKey:""}}),actions:{async init(t="task"){this.mode=t,this.mode=="chat"&&(this.agent={}),console.log("init",t);let n=await c.list(t,this.agent.id)||[];n.sort((i,s)=>new Date(s.update_at)-new Date(i.update_at)),this.list=n},async selectFirst(){this.mode=="task"&&this.list.length>0?(console.log(" 默认选择第一个 selectFirst"),this.conversationId=this.list[0].conversation_id,this.clearMessages(),this.chat=this.list[0],this.initConversation(this.conversationId),console.log("this.chat",this.chat)):(this.clearMessages(),this.chat={},this.conversationId=null)},async handleStop(){this.mode_editor?await c.stopCoding(this.conversationId):this.mode==="task"?await c.stop(this.conversationId):(this.chatInfo.cursorKey="",await c.stopChat(this.conversationId)),this.list.find(t=>t.conversation_id===this.conversationId).status="done",this.chat.status="done",this.status="done"},clearMessages(){this.messages=[],this.isScrolledToBottom=!0,this.status=="done",this.chatInfo.pid=-1},deleteMessage(t){if(!t)return;const e=this.messages.findIndex(n=>n.id===t);e!==-1&&this.messages.splice(e,1)},clearAgent(){this.agent={},this.list=[],console.log("clearAgent",this.agent)},async initConversation(t){console.log("initConversation"),await this.resetChatInfo();let e=await c.messageList(t);if(this.messages=[],this.mode==="task"){e.forEach(i=>{i.meta&&typeof i.meta=="string"&&(i.meta=JSON.parse(i.meta));const{action_type:s}=i.meta;if(s=="error"||s=="stop"){let o=i.conversation_id,a=this.list.find(r=>r.conversation_id==o);a&&(a.status="done")}I.handleMessage(i,this.messages)});const n=e[e.length-1];if(n&&n.meta){const{action_type:i}=n.meta;if(i==="error"||i==="stop"){let s=n.conversation_id,o=this.list.find(a=>a.conversation_id==s);o&&(o.status="done")}}}else this.mode==="chat"&&(this.chatInfo.msgList=e);this.scrollToBottom()},async playback(t,e=0){this.stopReplay=!1,this.replayStatus="running",this.messages=[];const n=await c.get(t);this.chat=n;let i=await c.messageList(t);for(let s of i){let o=100;this.stopReplay||(await new Promise(a=>setTimeout(a,e)),o=0),I.handleMessage(s,this.messages),setTimeout(()=>{const a=window.innerWidth<=768;a||v.emit("preview",{message:s});let r=JSON.parse(JSON.stringify(s.meta)),u=(r==null?void 0:r.json[0])||{};console.log("meta.action_type",r.action_type),r.action_type=="finish_summery"&&u&&!a&&v.emit("fullPreviewVisable",u)},o),this.isScrolledToBottom=!0,this.scrollToBottom(0)}this.replayStatus="done"},async toResult(){this.replayStatus="done",this.stopReplay=!0},async autoTitle(){if(this.updateTitle){const t=await c.update(this.conversationId,"");console.log("update_res",t);const e=await c.get(this.conversationId);this.chat.title=e.title,this.chat.status="running",this.list.find(n=>n.conversation_id===this.conversationId).title=e.title,this.list.find(n=>n.conversation_id===this.conversationId).status="running",console.log("this.list",this.list),this.updateTitle=!1,this.status="running"}},async updateConversationTitle(t){const e=await c.update(this.conversationId,t);this.chat.title=t;const n=this.list.find(i=>i.conversation_id===this.conversationId);n&&(n.title=e.title)},async updateConversationTitleById(t,e){const n=await c.update(e,t),i=this.list.find(s=>s.conversation_id===e);i&&(i.title=n.title),e===this.conversationId&&(this.chat.title=t)},async updateConversationVisibility(t){const e=await c.updateVisibility(this.conversationId,t);this.chat.is_public=t;const n=this.list.find(i=>i.conversation_id===this.conversationId);return n&&(n.is_public=t),e},async updateConversationVisibilityById(t,e){const n=await c.updateVisibility(e,t),i=this.list.find(s=>s.conversation_id===e);return i&&(i.is_public=t),e===this.conversationId&&(this.chat.is_public=t),n},onMessageEvent(t){const{source:e,message:n}=t},async createConversation(t,e="task"){console.log("createConversation",this.model_id),this.messages=[],await this.resetChatInfo(),this.updateTitle=!0;const n=await c.create(t,e,this.agent.id,this.model_id);return this.chat=n,this.conversationId=n.conversation_id,e=="task"?this.init():this.init("chat"),this.autoTitle(),n},async resetChatInfo(){this.chatInfo={pid:-1,msgList:[]}},sendMessage(t){},handleInitMessage(t,e=[],n="",i=""){console.log("handleInitMessage",t),this.mode_editor=!1;let s={json:e,action_type:"question"};n&&i&&(this.mode_editor=!0,s.json={files:e,screenshot:n,filepath:i});const o={content:t,timestamp:new Date().getTime(),meta:s,role:"user",is_temp:!0};this.messages.push(o);const a={content:"",role:"assistant",timestamp:new Date().getTime(),is_temp:!0};this.messages.push(a),this.isScrolledToBottom=!0,this.scrollToBottom()},async removeConversation(t){const e=await c.remove(t);let n=this.list.findIndex(i=>i.conversation_id===t);return n!==-1&&this.list.splice(n,1),e},scrollToBottom(t=500){setTimeout(()=>{console.log("scrollToBottom",this.isScrolledToBottom);const e=document.querySelector(".chat-messages");this.isScrolledToBottom&&(e.scrollTop=e.scrollHeight-e.clientHeight)},t)},async favorite(){await c.favorite(this.conversationId),this.chat.is_favorite=!0},async unfavorite(){await c.unfavorite(this.conversationId),this.chat.is_favorite=!1},async convertToTree(t){console.log("初始化tree",t);const e=new Map;t.forEach(i=>{const s=JSON.parse(i.meta);console.log("meta",s),e.set(i.id,{id:i.id,pid:s.pid,role:i.role,content:i.content,children:[]})});const n=[];return e.forEach(i=>{if(i.pid==="-1")n.push(i);else{const s=e.get(Number(i.pid));s&&s.children.push(i)}}),n.sort((i,s)=>i.id-s.id),n}},persist:!0}),A={xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",class:"lucide lucide-x h-5 w-5 text-[var(--icon-tertiary)]"};function F(t,e){return _(),y("svg",A,e[0]||(e[0]=[p("path",{d:"M18 6 6 18M6 6l12 12"},null,-1)]))}const W={render:F},G=t=>{const e=new Date(t),n=new Date,i=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return isNaN(i)?"":i===n.getFullYear()?`${s}/${o}`:`${i}/${s}/${o}`},X=t=>{const e=new Date(t),n=new Date,i=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0"),a=String(e.getHours()).padStart(2,"0"),r=String(e.getMinutes()).padStart(2,"0"),u=String(e.getSeconds()).padStart(2,"0");return isNaN(i)?"":i===n.getFullYear()?`${s}/${o} ${a}:${r}:${u}`:`${i}/${s}/${o} ${a}:${r}:${u}`},q={xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",fill:"none",stroke:"#535350","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",class:"lucide lucide-ellipsis text-[var(--icon-secondary)]",viewBox:"0 0 24 24"};function H(t,e){return _(),y("svg",q,e[0]||(e[0]=[p("circle",{cx:"12",cy:"12",r:"1"},null,-1),p("circle",{cx:"19",cy:"12",r:"1"},null,-1),p("circle",{cx:"5",cy:"12",r:"1"},null,-1)]))}const Z={render:H},J={xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"none",stroke:"#535350","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",class:"lucide lucide-pencil",viewBox:"0 0 24 24"};function O(t,e){return _(),y("svg",J,e[0]||(e[0]=[p("path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497zM15 5l4 4"},null,-1)]))}const tt={render:O};export{Z as M,X as a,W as c,tt as e,G as f,I as m,c as s,Q as u,j as v};
