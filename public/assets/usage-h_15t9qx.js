import{_ as ae,c,l as t,a as m,j as f,t as n,F as U,Y as B,w as k,C as se,X as re,u as F,d as V,Z as W,r,e as q,o as Q,g as b,$ as G,h as d,a0 as ie,a1 as le}from"./index-COUhflQL.js";import{s as J}from"./auth-D-et7D_s.js";import{s as g}from"./membership-C5eKkiGZ.js";import{u as K}from"./user-B_oAAdlF.js";import{W as ce,S as de}from"./wechatpay-tED_5vSf.js";import"./http-B5vhwVWP.js";const me={__name:"usage",setup(p,{expose:i}){i();const{t:s}=F(),e=V(),M=K(),{user:N,membership:w,points:P}=W(M),u=r(!0),T=q(()=>u.value?"$":"¥");async function y(){let o=await J.getUserInfo();w.value=o.membership,P.value=o.points}const a=r(1),S=r(5),R=r(0),L=r([]),D=r(!1),O=r(""),I=r(!1),C=r(null),x=r(null),v=r(!1),Y=r(!1),E=r([]);Q(()=>{y(),A(),window.electronAPI&&(window.electronAPI.on("stripe-payment-success",({orderId:o,amount:l,currency:_,status:h})=>{console.log("stripe-payment-success",o,l,_,h),h==="paid"?(b.success(s("member.paySuccess")),e.push({name:"app"})):b.error(s("member.payFailed"))}),window.electronAPI.on("stripe-payment-cancel",()=>{b.error(s("member.payCancel"))}))});function X(o){switch(o){case"FREE":return s("member.pointsType.free");case"MONTHLY":return s("member.pointsType.monthly");case"PURCHASED_ADDON":return s("member.pointsType.purchasedAddon");case"GIFTED_ADDON":return s("member.pointsType.giftedAddon");case"FEEDBACK_ADDON":return s("member.pointsType.feedbackAddon")}}const Z=async o=>{I.value=!0,C.value=o},$=async o=>{if(I.value=!1,v.value=!0,o==="stripe"){let _=await g.createStripePointPurchaseOrder(C.value.id,"web");window.location.href=_.url,v.value=!1}else{let l=await g.createPointPurchaseOrder(C.value.id);l&&l.code_url?(v.value=!1,O.value=l.code_url,D.value=!0,z(l.order_sn)):v.value=!1,console.log(l)}},z=async o=>{let _=0;x.value=setInterval(async()=>{_++;const h=await g.checkOrderStatus(o);(h==null?void 0:h.status)==="paid"&&(clearInterval(x.value),D.value=!1,b.success(s("member.paymentSuccess")),H(),console.log("支付成功")),_>=20&&(clearInterval(x.value),console.warn("支付超时，请重新下单"))},3e3)},H=()=>{window.location.reload()},A=async()=>{const o=await g.getPointsTransactionList({page:a.value,pageSize:S.value});console.log(o),R.value=o.pagination.total,L.value=o.list},ee=o=>{a.value=o.current,S.value=o.pageSize,A()},te=()=>{e.push({name:"pricing"})},oe=async()=>{let o=await g.getRechargeProductList();E.value=o||[],Y.value=!0},ne=[{title:s("member.table.details"),dataIndex:"description",key:"description"},{title:s("member.table.time"),dataIndex:"created_at",key:"created_at",customRender:({text:o})=>G(o).format("YYYY-MM-DD HH:mm")},{title:s("member.table.pointsChange"),key:"amount",customRender:({record:o})=>`${o.type==="credit"?"+":o.type==="debit"?"-":""}${o.amount}`}],j={t:s,router:e,userStore:M,user:N,membership:w,points:P,isAbroad:u,currency:T,getUserInfo:y,page:a,pageSize:S,total:R,data:L,showQrCode:D,qrCodeUrl:O,showPaymentMethodModal:I,selectedPlan:C,pollingTimer:x,loading:v,isModalVisible:Y,rechargeProducts:E,getPointsTypeName:X,handleBuy:Z,handlePayment:$,checkOrderStatus:z,paySuccess:H,getPointsTransactionList:A,handleTableChange:ee,toMember:te,toPoints:oe,columns:ne,ref:r,onMounted:Q,computed:q,get auth(){return J},get membershipService(){return g},get useI18n(){return F},get dayjs(){return G},get useRouter(){return V},get message(){return b},get storeToRefs(){return W},get useUserStore(){return K},get StripeLogo(){return de},get WechatLogo(){return ce}};return Object.defineProperty(j,"__isScriptSetup",{enumerable:!1,value:!0}),j}},pe={class:"usage"},ue={class:"member-info"},_e={style:{display:"flex","align-items":"center","justify-content":"space-between"}},he={class:"plan-name"},ge={key:0,class:"expiration-date"},ye={style:{gap:"12px",display:"flex"}},ve={class:"points-details"},fe={class:"points-details-text-container"},be={class:"points-details-text"},we={class:"points-details-total"},Pe={class:"points-details-accounts"},Se={class:"points-accounts"},Ce={class:"points-accounts"},xe={key:0,class:"recharge-products"},ke={class:"product-title"},Me={class:"product-info"},Te={style:{"margin-top":"8px"}},De=["loading","onClick"],Ie={key:1},Ae={style:{"text-align":"center",display:"flex","flex-direction":"column","align-items":"center"}},Ue={style:{display:"inline-block"}},Ne={style:{"margin-top":"12px"}},Re={style:{display:"flex","flex-direction":"column",gap:"16px",padding:"12px 4px"}},Le={class:"payment-content"},Oe={class:"payment-title"},Ye={class:"payment-description"},Ee={class:"payment-content"},ze={class:"payment-title"},He={class:"payment-description"};function je(p,i,s,e,M,N){var y;const w=ie,P=se,u=re,T=le;return d(),c(U,null,[t("div",pe,[t("div",ue,[t("div",_e,[t("div",null,[t("div",he,n(((y=e.membership)==null?void 0:y.planName)||e.t("member.freePlan")),1),e.membership?(d(),c("div",ge,n(e.t("member.expirationDate"))+n(e.dayjs(e.membership.endDate).format("YYYY-MM-DD HH:mm")),1)):f("v-if",!0)]),t("div",ye,[t("button",{onClick:e.toMember,class:"upgrade"},n(e.t("member.upgrade")),1),e.membership?(d(),c("button",{key:0,onClick:e.toPoints,class:"upgrade"},n(e.t("member.purchasePoints")),1)):f("v-if",!0)])]),t("div",ve,[t("div",fe,[t("div",be,n(e.t("member.points")),1),t("div",we,n(e.points.total),1)]),t("div",null,[(d(!0),c(U,null,B(e.points.accounts,a=>(d(),c("div",Pe,[t("div",Se,n(e.getPointsTypeName(a.type)),1),t("div",Ce,n(a.balance),1)]))),256))])])]),m(P,{title:e.t("member.pointsUsageHistory")},{default:k(()=>[m(w,{columns:e.columns,onChange:e.handleTableChange,"data-source":e.data,"row-key":"id",pagination:{current:e.page,pageSize:e.pageSize,page:e.page,total:e.total}},null,8,["data-source","pagination"])]),_:1},8,["title"])]),m(u,{open:e.isModalVisible,"onUpdate:open":i[0]||(i[0]=a=>e.isModalVisible=a),title:e.t("member.purchasePoints"),footer:null,width:"800px",class:"recharge-modal",centered:""},{default:k(()=>[e.rechargeProducts.length?(d(),c("div",xe,[(d(!0),c(U,null,B(e.rechargeProducts,a=>(d(),c("div",{key:a.id,class:"product-card"},[t("div",ke,n(a.product_name),1),t("div",Me,[t("p",Te,n(e.currency)+" "+n(a.amount),1),t("p",null,n(a.points_awarded)+n(e.t("member.pointsUnit")),1)]),t("button",{size:"small",loading:e.loading,onClick:S=>e.handleBuy(a)},n(e.t("member.buyNow")),9,De)]))),128))])):(d(),c("div",Ie,n(e.t("member.noPackagesAvailable")),1))]),_:1},8,["open","title"]),m(u,{open:e.showQrCode,"onUpdate:open":i[1]||(i[1]=a=>e.showQrCode=a),title:e.t("member.wechatScanToPay"),centered:"",footer:null},{default:k(()=>[t("div",Ae,[t("div",Ue,[m(T,{value:e.qrCodeUrl,size:200},null,8,["value"])]),t("p",Ne,n(e.t("member.wechatScanPrompt")),1)])]),_:1},8,["open","title"]),f(" 支付方式选择弹窗 "),m(u,{open:e.showPaymentMethodModal,"onUpdate:open":i[4]||(i[4]=a=>e.showPaymentMethodModal=a),footer:null,centered:"",width:"480",title:p.$t("member.selectPaymentMethod")},{default:k(()=>[t("div",Re,[f(" Stripe "),t("div",{class:"payment-option",onClick:i[2]||(i[2]=a=>e.handlePayment("stripe"))},[m(e.StripeLogo),t("div",Le,[t("div",Oe,n(p.$t("payment.stripe.title")),1),t("div",Ye,n(p.$t("payment.stripe.description")),1)])]),f(" WeChat "),t("div",{class:"payment-option",onClick:i[3]||(i[3]=a=>e.handlePayment("wechat"))},[m(e.WechatLogo),t("div",Ee,[t("div",ze,n(p.$t("payment.wechat.title")),1),t("div",He,n(p.$t("payment.wechat.description")),1)])])])]),_:1},8,["open","title"])],64)}const Ge=ae(me,[["render",je],["__scopeId","data-v-b5da7772"],["__file","/Users/samihalawa/git/PROJECTS_CODING/lemonai/frontend/src/view/auth/usage.vue"]]);export{Ge as default};
