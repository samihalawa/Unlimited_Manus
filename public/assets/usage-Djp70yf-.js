import{s as Z}from"./auth-BilQ5inf.js";import{s as v}from"./membership-CEM-4zoR.js";import{q as J,u as ee,X as te,r as l,c as se,o as ae,f as g,g as ne,Y as R,d as c,l as t,e as u,j as O,t as n,x as o,F as T,Z as E,w as b,C as oe,W as ie,h as r,$ as le,a0 as ce}from"./index-BlGINy0I.js";import{u as re}from"./user-CVczdK57.js";import{S as de,W as pe}from"./wechatpay-BiE4JYAf.js";import"./http-BD0bo4QE.js";const ue={class:"usage"},me={class:"member-info"},_e={style:{display:"flex","align-items":"center","justify-content":"space-between"}},ve={class:"plan-name"},ye={key:0,class:"expiration-date"},fe={style:{gap:"12px",display:"flex"}},he={class:"points-details"},ge={class:"points-details-text-container"},be={class:"points-details-text"},we={class:"points-details-total"},xe={class:"points-details-accounts"},Pe={class:"points-accounts"},ke={class:"points-accounts"},Ce={key:0,class:"recharge-products"},Se={class:"product-title"},De={class:"product-info"},Te={style:{"margin-top":"8px"}},$e=["loading","onClick"],Ae={key:1},Ie={style:{"text-align":"center",display:"flex","flex-direction":"column","align-items":"center"}},Me={style:{display:"inline-block"}},Ne={style:{"margin-top":"12px"}},Ue={style:{display:"flex","flex-direction":"column",gap:"16px",padding:"12px 4px"}},Ye={class:"payment-content"},Re={class:"payment-title"},Oe={class:"payment-description"},Ee={class:"payment-content"},He={class:"payment-title"},Le={class:"payment-description"},ze={__name:"usage",setup(Fe){const{t:s}=ee(),$=ne(),H=re(),{user:Be,membership:m,points:w}=te(H),L=l(!0),z=se(()=>L.value?"$":"¥");async function F(){let e=await Z.getUserInfo();m.value=e.membership,w.value=e.points}const y=l(1),x=l(5),A=l(0),I=l([]),f=l(!1),M=l(""),h=l(!1),P=l(null),k=l(null),_=l(!1),C=l(!1),S=l([]);ae(()=>{F(),U(),window.electronAPI&&(window.electronAPI.on("stripe-payment-success",({orderId:e,amount:a,currency:d,status:p})=>{console.log("stripe-payment-success",e,a,d,p),p==="paid"?(g.success(s("member.paySuccess")),$.push({name:"app"})):g.error(s("member.payFailed"))}),window.electronAPI.on("stripe-payment-cancel",()=>{g.error(s("member.payCancel"))}))});function B(e){switch(e){case"FREE":return s("member.pointsType.free");case"MONTHLY":return s("member.pointsType.monthly");case"PURCHASED_ADDON":return s("member.pointsType.purchasedAddon");case"GIFTED_ADDON":return s("member.pointsType.giftedAddon");case"FEEDBACK_ADDON":return s("member.pointsType.feedbackAddon")}}const V=async e=>{h.value=!0,P.value=e},N=async e=>{if(h.value=!1,_.value=!0,e==="stripe"){let d=await v.createStripePointPurchaseOrder(P.value.id,"web");window.location.href=d.url,_.value=!1}else{let a=await v.createPointPurchaseOrder(P.value.id);a&&a.code_url?(_.value=!1,M.value=a.code_url,f.value=!0,j(a.order_sn)):_.value=!1,console.log(a)}},j=async e=>{let d=0;k.value=setInterval(async()=>{d++;const p=await v.checkOrderStatus(e);(p==null?void 0:p.status)==="paid"&&(clearInterval(k.value),f.value=!1,g.success(s("member.paymentSuccess")),q(),console.log("支付成功")),d>=20&&(clearInterval(k.value),console.warn("支付超时，请重新下单"))},3e3)},q=()=>{window.location.reload()},U=async()=>{const e=await v.getPointsTransactionList({page:y.value,pageSize:x.value});console.log(e),A.value=e.pagination.total,I.value=e.list},W=e=>{y.value=e.current,x.value=e.pageSize,U()},G=()=>{$.push({name:"pricing"})},K=async()=>{let e=await v.getRechargeProductList();S.value=e||[],C.value=!0},Q=[{title:s("member.table.details"),dataIndex:"description",key:"description"},{title:s("member.table.time"),dataIndex:"created_at",key:"created_at",customRender:({text:e})=>R(e).format("YYYY-MM-DD HH:mm")},{title:s("member.table.pointsChange"),key:"amount",customRender:({record:e})=>`${e.type==="credit"?"+":e.type==="debit"?"-":""}${e.amount}`}];return(e,a)=>{var Y;const d=le,p=oe,D=ie,X=ce;return r(),c(T,null,[t("div",ue,[t("div",me,[t("div",_e,[t("div",null,[t("div",ve,n(((Y=o(m))==null?void 0:Y.planName)||o(s)("member.freePlan")),1),o(m)?(r(),c("div",ye,n(o(s)("member.expirationDate"))+n(o(R)(o(m).endDate).format("YYYY-MM-DD HH:mm")),1)):O("",!0)]),t("div",fe,[t("button",{onClick:G,class:"upgrade"},n(o(s)("member.upgrade")),1),o(m)?(r(),c("button",{key:0,onClick:K,class:"upgrade"},n(o(s)("member.purchasePoints")),1)):O("",!0)])]),t("div",he,[t("div",ge,[t("div",be,n(o(s)("member.points")),1),t("div",we,n(o(w).total),1)]),t("div",null,[(r(!0),c(T,null,E(o(w).accounts,i=>(r(),c("div",xe,[t("div",Pe,n(B(i.type)),1),t("div",ke,n(i.balance),1)]))),256))])])]),u(p,{title:o(s)("member.pointsUsageHistory")},{default:b(()=>[u(d,{columns:Q,onChange:W,"data-source":I.value,"row-key":"id",pagination:{current:y.value,pageSize:x.value,page:y.value,total:A.value}},null,8,["data-source","pagination"])]),_:1},8,["title"])]),u(D,{open:C.value,"onUpdate:open":a[0]||(a[0]=i=>C.value=i),title:o(s)("member.purchasePoints"),footer:null,width:"800px",class:"recharge-modal",centered:""},{default:b(()=>[S.value.length?(r(),c("div",Ce,[(r(!0),c(T,null,E(S.value,i=>(r(),c("div",{key:i.id,class:"product-card"},[t("div",Se,n(i.product_name),1),t("div",De,[t("p",Te,n(z.value)+" "+n(i.amount),1),t("p",null,n(i.points_awarded)+n(o(s)("member.pointsUnit")),1)]),t("button",{size:"small",loading:_.value,onClick:Ve=>V(i)},n(o(s)("member.buyNow")),9,$e)]))),128))])):(r(),c("div",Ae,n(o(s)("member.noPackagesAvailable")),1))]),_:1},8,["open","title"]),u(D,{open:f.value,"onUpdate:open":a[1]||(a[1]=i=>f.value=i),title:o(s)("member.wechatScanToPay"),centered:"",footer:null},{default:b(()=>[t("div",Ie,[t("div",Me,[u(X,{value:M.value,size:200},null,8,["value"])]),t("p",Ne,n(o(s)("member.wechatScanPrompt")),1)])]),_:1},8,["open","title"]),u(D,{open:h.value,"onUpdate:open":a[4]||(a[4]=i=>h.value=i),footer:null,centered:"",width:"480",title:e.$t("member.selectPaymentMethod")},{default:b(()=>[t("div",Ue,[t("div",{class:"payment-option",onClick:a[2]||(a[2]=i=>N("stripe"))},[u(o(de)),t("div",Ye,[t("div",Re,n(e.$t("payment.stripe.title")),1),t("div",Oe,n(e.$t("payment.stripe.description")),1)])]),t("div",{class:"payment-option",onClick:a[3]||(a[3]=i=>N("wechat"))},[u(o(pe)),t("div",Ee,[t("div",He,n(e.$t("payment.wechat.title")),1),t("div",Le,n(e.$t("payment.wechat.description")),1)])])])]),_:1},8,["open","title"])],64)}}},Xe=J(ze,[["__scopeId","data-v-4008df5d"]]);export{Xe as default};
