import{a as T,I as ct,_ as ut,c as S,h as w,l as s,j as h,t as o,a2 as dt,w as V,k as $,B as mt,F as ve,Y as Re,a1 as ft,X as q,i as be,u as Ee,d as Le,Z as Ae,r as b,e as x,o as ze,v as Ge,A as v,g as d,a3 as pt}from"./index-COUhflQL.js";import{u as Ve}from"./user-B_oAAdlF.js";import{s as y}from"./membership-C5eKkiGZ.js";import{W as gt,S as vt}from"./wechatpay-tED_5vSf.js";import{s as qe}from"./auth-D-et7D_s.js";var bt={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M880 310H732.4c13.6-21.4 21.6-46.8 21.6-74 0-76.1-61.9-138-138-138-41.4 0-78.7 18.4-104 47.4-25.3-29-62.6-47.4-104-47.4-76.1 0-138 61.9-138 138 0 27.2 7.9 52.6 21.6 74H144c-17.7 0-32 14.3-32 32v200c0 4.4 3.6 8 8 8h40v344c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V550h40c4.4 0 8-3.6 8-8V342c0-17.7-14.3-32-32-32zm-334-74c0-38.6 31.4-70 70-70s70 31.4 70 70-31.4 70-70 70h-70v-70zm-138-70c38.6 0 70 31.4 70 70v70h-70c-38.6 0-70-31.4-70-70s31.4-70 70-70zM180 482V378h298v104H180zm48 68h250v308H228V550zm568 308H546V550h250v308zm48-376H546V378h298v104z"}}]},name:"gift",theme:"outlined"};function We(i){for(var u=1;u<arguments.length;u++){var M=arguments[u]!=null?Object(arguments[u]):{},t=Object.keys(M);typeof Object.getOwnPropertySymbols=="function"&&(t=t.concat(Object.getOwnPropertySymbols(M).filter(function(F){return Object.getOwnPropertyDescriptor(M,F).enumerable}))),t.forEach(function(F){yt(i,F,M[F])})}return i}function yt(i,u,M){return u in i?Object.defineProperty(i,u,{value:M,enumerable:!0,configurable:!0,writable:!0}):i[u]=M,i}var ye=function(u,M){var t=We({},u,M.attrs);return T(ct,We({},t,{icon:bt}),null)};ye.displayName="GiftOutlined";ye.inheritAttrs=!1;const _t={__name:"pricing",props:{isWindow:{type:Boolean,default:!1},showTitle:{type:Boolean,default:!0}},emits:["close_window"],setup(i,{expose:u,emit:M}){u();const{t}=Ee(),F=Le(),se=Ve(),{membership:m,points:Y}=Ae(se),D=b(!1),B=b(!1),j=b(!0),l=()=>{var e;return(e=m.value)!=null&&e.durationDays?m.value.durationDays===365?"year":"month":"year"},P=b(l()),L=[{label:()=>v("div",[v("span",t("member.billingMonthly"))]),value:"month"},{label:()=>v("div",{style:"display: flex; align-items: center; gap: 4px;"},[v("span",t("member.billingYearly")),v("span",{style:"color: #0081f2; font-size: 13px; font-weight: 500;"},"Save 16%")]),value:"year"}],N=b([]),p=b({}),ee=b(!1),le=b(""),te=b(!1),ne=b(null),R=b(null),Ye=x(()=>"$"),ce=b(!1),ue=b(!1),J=b(null),U=b(!1),C=b(null),k=b(null),de=i,me=M,je=()=>{ce.value=!0},_e=async()=>{var n,a,r;console.log("Subscription canceled",m.value.subscription_id);let e=m.value.subscription_id;if(e||(e=((r=(a=(n=(await y.getSubscriptionInfo()).subscription)==null?void 0:n.data)==null?void 0:a[0])==null?void 0:r.id)??null),e){let c=await y.cancelSubscription({subscription_id:e});console.log("=== cancel_res === ",c),await A(),await z()}},E=b(null),A=async()=>{var n,a;let e=await y.getSubscriptionInfo();return E.value=((a=(n=e.subscription)==null?void 0:n.data)==null?void 0:a[0])??null,e},he=x(()=>{var e;return(e=E.value)==null?void 0:e.cancel_at_period_end}),re=x(()=>{var e,n;return((n=(e=E.value)==null?void 0:e.metadata)==null?void 0:n.action)==="downgrade"}),ae=x(()=>he.value&&!re.value),He=x(()=>{var e,n;return!re.value||!((n=(e=E.value)==null?void 0:e.metadata)!=null&&n.target_plan_name)?null:E.value.metadata.target_plan_name}),Je=x(()=>{var a,r,c,f;const e=(f=(c=(r=(a=E.value)==null?void 0:a.items)==null?void 0:r.data)==null?void 0:c[0])==null?void 0:f.current_period_end;return e?new Date(e*1e3).toLocaleDateString("en-US",{year:"numeric",month:"2-digit",day:"2-digit"}):""}),we=x(()=>{const e={};return Q.value.forEach(n=>{var r;if(!!((r=m.value)!=null&&r.planName)&&n.plan_name==="Free"){e[n.id]=t("member.unavailable");return}if(pe(n))n.plan_name==="Free"?e[n.id]=t("member.unavailable"):e[n.id]=ae.value?t("member.reactivatePlan"):t("member.alreadyCurrentMember");else if(n.plan_name==="Free")e[n.id]=t("member.alreadyCurrentMember");else{let c=n.plan_name;n.duration_days===365?c=c+" "+t("member.year"):c=c+" "+t("member.month");const f=ie(n);f==="upgrade"?e[n.id]=t("member.upgradeTo")+" "+c:f==="downgrade"?e[n.id]=t("member.downgradeTo")+" "+c:e[n.id]=t("member.upgradeTo")+" "+c}}),e});function Qe(e){return we.value[e.id]}const ie=e=>{const n=m.value;if(!n)return null;const a={Pro:1,Business:2};return a[n.planName],a[e.plan_name],console.log("plan monthly_points",e.monthly_points),console.log("current monthlyPoints",n.monthlyPoints),console.log("plan duration_days",e.duration_days),console.log("current durationDays",n.durationDays),e.duration_days>=n.durationDays&&e.monthly_points>=n.monthlyPoints?"upgrade":e.duration_days<=n.durationDays&&e.monthly_points<=n.monthlyPoints?"downgrade":e.duration_days>n.durationDays?"upgrade":"none"},Pe=x(()=>{const e={};return Q.value.forEach(n=>{n.plan_name==="Free"?e[n.id]=!0:pe(n)?e[n.id]=!ae.value:e[n.id]=!1}),e}),Xe=e=>Pe.value[e.id],Ze=async()=>{D.value=!0;try{await _e(),ce.value=!1,d.success(t("member.cancelMembershipSuccess"))}finally{D.value=!1}},Ke=async()=>{if(J.value){D.value=!0;try{X()==="stripe"?(await y.downgradeSubscription({subscription_id:m.value.subscription_id,new_price_id:J.value.stripe_price_id}),d.success(t("member.downgradeScheduledSuccess")),await A(),await z()):d.info(t("member.downgradeNotSupported")),ue.value=!1,J.value=null}catch(e){console.error("降级失败:",e),d.error(t("member.downgradeFailed"))}finally{D.value=!1}}},$e=async()=>{B.value=!0;try{await y.cancelDowngrade({subscription_id:E.value.id}),d.success(t("member.cancelDowngradeSuccess")),await A(),await z()}catch(e){console.error("取消降级失败:",e),d.error(t("member.cancelDowngradeFailed"))}finally{B.value=!1}},et=e=>{if(e.plan_name==="Pro")return 38;if(e.plan_name==="Business")return 189},fe=e=>e.plan_name==="Pro"?16:e.plan_name==="Business"?83:0;ze(()=>{A()});const pe=e=>{var n,a;return((n=m.value)==null?void 0:n.planName)===e.plan_name&&((a=m.value)==null?void 0:a.durationDays)===e.duration_days},Q=x(()=>N.value.filter(e=>P.value==="year"?e.duration_days===365:e.duration_days===30)),tt=()=>F.push({name:"lemon"}),Ce=x(()=>({Free:[{title:t("member.benefits.free.newUserCredits"),iconType:"GiftOutlined"},{title:t("member.benefits.free.dailyCredits")},{title:t("member.benefits.free.publicAgentsOnly")},{title:t("member.benefits.free.systemExperienceInvisible")},{title:t("member.benefits.free.limitedChat")},{title:t("member.benefits.free.limitedAgent")}],Pro:[{title:t("member.benefits.pro.monthlyCredits"),iconType:"GiftOutlined"},{title:t("member.benefits.pro.dailyCredits")},{title:t("member.benefits.pro.privateAgents")},{title:t("member.benefits.pro.systemExperienceEditable")},{title:t("member.benefits.pro.unlimitedChat")},{title:t("member.benefits.pro.unlimitedAgent")}],Business:[{title:t("member.benefits.business.monthlyCredits"),iconType:"GiftOutlined"},{title:t("member.benefits.business.dailyCredits")},{title:t("member.benefits.business.privateAgents")},{title:t("member.benefits.business.systemExperienceEdit")},{title:t("member.benefits.business.unlimitedChat")},{title:t("member.benefits.business.unlimitedAgent")},{title:t("member.benefits.business.earlyAccess")},{title:t("member.benefits.business.customDomains")},{title:t("member.benefits.business.teamShare")}]})),Se=async()=>{try{const e=await y.getList();e.unshift({id:0,plan_name:"Free",price:0,duration_days:30},{id:1,plan_name:"Free",price:0,duration_days:365}),e.forEach(n=>{n.benefits=Ce.value[n.plan_name]||[]}),N.value=e,Q.value.forEach(n=>{n.duration_days==30?H.value[n.id]=Number(n.price):H.value[n.id]=Number(fe(n))})}catch{d.error(t("member.loadPlansFailed"))}};Se();const H=b({}),W={};function nt(e){return Number(e).toFixed(2)}function De(e,n){const a=N.value.find(r=>r.plan_name===e&&r.duration_days===n);return a?Number(a.price):0}function rt(){if(!m.value)return 0;const e=N.value.find(n=>n.plan_name===m.value.planName&&n.duration_days===m.value.durationDays);return e?Number(e.price):0}function ke(e,n,a,r=300){W[e]&&(clearInterval(W[e]),W[e]=null);const c=30,f=Math.round(r/(1e3/c));let g=0;const O=a-n;W[e]=setInterval(()=>{g++,g>=f?(H.value[e]=a,clearInterval(W[e]),W[e]=null):H.value[e]=n+O*g/f},1e3/c)}Ge(P,(e,n)=>{if(!N.value.length)return;const a=n==="year"?365:30;Q.value.forEach(r=>{const c=r.id;let f=Number(r.price);r.duration_days==365&&(f=Number(fe(r)));const g=De(r.plan_name,a);H.value[c]=g,ke(c,g,f)})});const at=async e=>{var n,a,r,c,f;if(re.value&&ie(e)==="downgrade"){d.info(t("member.cancelPleaseFirst"));return}if(ae.value&&((n=m.value)==null?void 0:n.planName)===e.plan_name&&((a=m.value)==null?void 0:a.durationDays)===e.duration_days){p.value={...p.value,[e.id]:!0},await y.reactivateSubscription({subscription_id:E.value.id}),d.success(t("member.reactivateSuccess")),p.value={...p.value,[e.id]:!1},A(),await z();return}if(console.log("membership.value?.planName",(r=m.value)==null?void 0:r.planName),(c=m.value)!=null&&c.planName){const g=ie(e);if(console.log("upgradeOrDowngrade",g),g==="upgrade"){if(!j.value&&((f=m.value)!=null&&f.planName)&&m.value.planName!=="Free"){d.info(t("member.platformNotSupported"));return}if(X()==="stripe")try{p.value={...p.value,[e.id]:!0};const I=await y.previewUpgrade({current_plan_id:m.value.planId,new_plan_id:e.id});k.value=I,C.value=e,U.value=!0,p.value={...p.value,[e.id]:!1};return}catch{d.error(t("member.upgradePreviewFailed")),p.value={...p.value,[e.id]:!1};return}else try{p.value={...p.value,[e.id]:!0};const I=await y.previewUpgrade({current_plan_id:m.value.planId,new_plan_id:e.id});k.value=I,C.value=e,U.value=!0,p.value={...p.value,[e.id]:!1};return}catch{d.error(t("member.upgradePreviewFailed")),p.value={...p.value,[e.id]:!1};return}}else if(g==="none"){d.error(t("member.switchNotSupported"));return}else if(g===null){ne.value=e,te.value=!0;return}else if(g==="downgrade"){if(!j.value){d.info(t("member.platformNotSupported"));return}if(X()==="wechat"){d.info(t("member.wechatDowngradeNotSupported"));return}J.value=e,ue.value=!0;return}}ne.value=e,te.value=!0},X=()=>{var e;return(e=m.value)!=null&&e.subscription_id?"stripe":"wechat"},it=async()=>{var n,a,r,c,f;if(!C.value||!k.value)return;D.value=!0;let e=null;try{if(X()==="stripe"){const O=Math.round(parseFloat(k.value.upgrade_price)*100);if(e=await y.upgradeSubscription({subscription_id:m.value.subscription_id,new_price_id:C.value.stripe_price_id,custom_amount:O}),console.log("=== upgradeResult === ",e),((n=e.data)==null?void 0:n.payment_failed)===!0||((a=e.data)==null?void 0:a.success)===!1){let I=((r=e.data)==null?void 0:r.message)||t("member.upgradeFailed"),Z=[];const K=[v("p",{style:"margin-bottom: 16px; color: #ff4d4f; font-weight: 500;"},I)];Z.length>0&&K.push(v("div",{style:"margin-top: 16px;"},[v("p",{style:"margin-bottom: 8px; font-weight: 500; color: #1890ff;"},t("member.whatYouCanDo")),v("ul",{style:"margin: 0; padding-left: 20px; color: #666;"},Z.map(oe=>v("li",{style:"margin-bottom: 4px; line-height: 1.4;"},oe)))])),q.error({title:t("member.upgradePaymentFailed"),width:480,content:v("div",K),okText:t("member.iUnderstand"),okType:"primary"}),U.value=!1,C.value=null,k.value=null;return}(c=e==null?void 0:e.order)!=null&&c.order_sn?(d.info(t("member.processingUpgrade")),Me(e.order.order_sn)):(d.success(t("member.upgradeSuccessful")),await new Promise(I=>setTimeout(I,2e3)),await A(),await z(),U.value=!1,C.value=null,k.value=null)}else{const O=await y.createMembershipUpgradeOrder({current_plan_id:m.value.planId,new_plan_id:C.value.id});le.value=O.code_url,ee.value=!0,ge(O.order_sn),U.value=!1,C.value=null,k.value=null}}catch(g){console.error("升级失败:",g),d.error(t("member.upgradeFailed")),U.value=!1,C.value=null,k.value=null}finally{(f=e==null?void 0:e.order)!=null&&f.order_sn||(D.value=!1)}},ot=()=>{U.value=!1,C.value=null,k.value=null},st=async(e,n)=>{console.log("=== method === ",e,n),p.value={...p.value,[n]:!0};const a=ne.value;te.value=!1;try{if(e==="stripe"){const r=await y.createStripeOrder(a.id);r!=null&&r.url&&(window.location.href=r.url)}else if(e==="wechat"){const r=await y.createOrder(a.id);le.value=r.code_url,ee.value=!0,ge(r.order_sn)}}catch(r){console.error("paymentFailed",r),d.error(t("member.paymentFailed"))}finally{p.value={...p.value,[n]:!1}}},ge=async e=>{let a=0;R.value=setInterval(async()=>{a++;const r=await y.checkOrderStatus(e);(r==null?void 0:r.status)==="paid"&&(clearInterval(R.value),ee.value=!1,d.success(t("member.paySuccess")),await z(),de.isWindow?me("close_window"):F.push("/pricing")),a>=20&&clearInterval(R.value)},3e3)},Me=async e=>{let a=0;D.value=!0,R.value=setInterval(async()=>{a++;try{const r=await y.checkOrderStatus(e);console.log(`=== 轮询订单状态 (第${a}次) ===`),console.log("订单状态:",r==null?void 0:r.status),(r==null?void 0:r.status)==="paid"?(clearInterval(R.value),D.value=!1,U.value=!1,C.value=null,k.value=null,d.success(t("member.upgradeSuccessful")),await A(),await z(),de.isWindow&&me("close_window")):(r==null?void 0:r.status)==="failed"?(console.log("=== 检测到订单失败 ==="),clearInterval(R.value),D.value=!1,U.value=!1,C.value=null,k.value=null,console.log("准备调用 handleUpgradeFailure"),await Oe(),console.log("handleUpgradeFailure 调用完成")):a>=20&&(clearInterval(R.value),D.value=!1,d.warning(t("member.upgradeTimeoutWarning")),U.value=!1,C.value=null,k.value=null)}catch(r){console.error("检查升级订单状态失败:",r),a>=20&&(clearInterval(R.value),D.value=!1,U.value=!1,C.value=null,k.value=null,d.error(t("member.upgradeStatusCheckFailed")))}},3e3)},Oe=async()=>{var e;try{const n=(e=m.value)==null?void 0:e.subscription_id;if(console.log("=== handleUpgradeFailure 调试信息 ==="),console.log("subscriptionId:",n),!n){console.log("没有找到 subscriptionId"),d.error(t("member.getSubscriptionFailed"));return}console.log("正在查询支付失败原因...");const a=await y.getPaymentFailureReason(n);console.log("支付失败原因查询结果:",a),console.log("failureResult.success:",a.success),console.log("failureResult.data:",a.data);const r=a.success?a.data:a;if(r&&(r.failure_reason||r.failure_code||r.failure_message)){let c=t("member.upgradeFailed"),f=[];r.failure_code==="insufficient_funds"?c=t("member.insufficientFunds"):r.failure_code==="card_declined"?c=t("member.cardDeclined"):r.failure_code==="authentication_required"?c=t("member.authenticationRequired"):r.failure_code==="expired_card"?c=t("member.expiredCard"):r.failure_code==="no_payment_method_or_failed"?(c=r.failure_message||t("member.paymentMethodIssue"),f=r.suggestions||[]):r.failure_code==="invoice_open"?(c=r.failure_message||t("member.invoiceUnpaid"),f=r.suggestions||[]):r.failure_message&&(c=r.failure_message,f=r.suggestions||[]);const g=[v("p",{style:"margin-bottom: 16px; color: #ff4d4f; font-weight: 500;"},c)];f.length>0&&g.push(v("div",{style:"margin-top: 16px;"},[v("p",{style:"margin-bottom: 8px; font-weight: 500; color: #1890ff;"},t("member.whatYouCanDo")),v("ul",{style:"margin: 0; padding-left: 20px; color: #666;"},f.map(O=>v("li",{style:"margin-bottom: 4px; line-height: 1.4;"},O)))])),console.log("准备显示 Modal 弹窗"),console.log("errorMessage:",c),console.log("suggestions:",f),console.log("failure_code:",r.failure_code),q.error({title:t("member.upgradePaymentFailed"),width:480,content:v("div",g),okText:t("member.iUnderstand"),okType:"primary"}),console.log("Modal.error 已调用")}else d.error(t("member.contactSupport"))}catch(n){console.error("查询升级失败原因出错:",n),d.error("Upgrade failed. Please try again or contact support.")}};async function z(){let e=await qe.getUserInfo();m.value=e.membership,Y.value=e.points}const Ue={t,router:F,userStore:se,membership:m,points:Y,confirmLoading:D,cancelDowngradeLoading:B,upgradeDowngradeEnabled:j,getDefaultBillingType:l,billingType:P,billingOptions:L,pricingPlans:N,loadingMap:p,showQrCode:ee,qrCodeUrl:le,showPaymentMethodModal:te,selectedPlan:ne,pollingTimer:R,currency:Ye,showCancelConfirm:ce,showDowngradeConfirm:ue,pendingDowngradePlan:J,showUpgradeConfirm:U,pendingUpgradePlan:C,upgradePreview:k,props:de,emits:me,openCancelMembership:je,cancelMembership:_e,subscriptionInfo:E,getSubscriptionInfo:A,cancelStatus:he,isDowngradeStatus:re,isTrueCancelStatus:ae,downgradeTargetPlan:He,formatPeriodEndDate:Je,planActionLabelsMap:we,getPlanActionLabel:Qe,isUpgradeOrDowngrade:ie,planDisabledMap:Pe,planDisabled:Xe,handleConfirmCancel:Ze,handleConfirmDowngrade:Ke,cancelDowngrade:$e,calculateYearlySavings:et,calculateMonthlyPrice:fe,isMember:pe,filteredPlans:Q,back:tt,membershipBenefitsMap:Ce,getMembershipPlan:Se,displayedPrices:H,timers:W,formatPrice:nt,getPlanPriceByName:De,getCurrentPlanPrice:rt,animatePrice:ke,pay:at,getPreviousPaymentMethod:X,handleConfirmUpgrade:it,cancelUpgradePreview:ot,handlePayment:st,checkOrderStatus:ge,checkUpgradeOrderStatus:Me,handleUpgradeFailure:Oe,getUserInfo:z,debugSubscription:async()=>{var e,n,a,r,c,f,g,O,I,Z,K,oe,Ie,Te,Ne,xe,Fe,Be;try{console.log("=== 开始调试订阅状态 ===");const G=await y.debugSubscription();if(console.log("=== 调试结果 ==="),console.log(JSON.stringify(G,null,2)),G!=null&&G.data){const _=G.data;console.log(`
=== 订阅基本信息 ===`),console.log("订阅ID:",(e=_.subscription)==null?void 0:e.id),console.log("状态:",(n=_.subscription)==null?void 0:n.status),console.log("当前价格ID:",(a=_.subscription)==null?void 0:a.current_price_id),console.log("下次计费时间:",(r=_.subscription)==null?void 0:r.current_period_end),console.log(`
=== Pending Items ===`),console.log("数量:",(c=_.pending_items)==null?void 0:c.count),console.log("总金额 USD:",(f=_.pending_items)==null?void 0:f.total_amount_usd),((O=(g=_.pending_items)==null?void 0:g.items)==null?void 0:O.length)>0&&console.table(_.pending_items.items),console.log(`
=== 即将到来的发票 ===`),console.log("预计金额 USD:",(I=_.upcoming_invoice)==null?void 0:I.amount_due_usd),((K=(Z=_.upcoming_invoice)==null?void 0:Z.lines)==null?void 0:K.length)>0&&console.table(_.upcoming_invoice.lines),console.log(`
=== 最近发票历史 ===`),((oe=_.recent_invoices)==null?void 0:oe.length)>0&&console.table(_.recent_invoices);const lt=`
订阅状态调试结果:

基本信息:
- 订阅ID: ${(Ie=_.subscription)==null?void 0:Ie.id}
- 状态: ${(Te=_.subscription)==null?void 0:Te.status}
- 下次计费: ${(Ne=_.subscription)==null?void 0:Ne.current_period_end}

Pending Items: ${(xe=_.pending_items)==null?void 0:xe.count} 项，总金额: $${(Fe=_.pending_items)==null?void 0:Fe.total_amount_usd}

下期账单预计: $${(Be=_.upcoming_invoice)==null?void 0:Be.amount_due_usd}

详细信息请查看浏览器控制台
      `;q.info({title:"Subscription Debug Result",content:v("pre",{style:"white-space: pre-wrap; font-family: monospace; font-size: 12px;"},lt),width:600,okText:"Got it"})}}catch(G){console.error("调试订阅状态失败:",G),d.error("Debug failed: "+G.message)}},cleanupPendingItems:async()=>{try{console.log("=== 开始清理 pending InvoiceItems ===");const e=await y.cleanupPendingItems();if(console.log("=== 清理结果 ==="),console.log(JSON.stringify(e,null,2)),e!=null&&e.data){const n=e.data,a=`
清理 Pending Items 结果:

${n.message}

详细信息:
- 删除了 ${n.deleted_count} 个升级相关项目
- 保留了 ${n.kept_count} 个其他项目

处理的项目:
${n.items.map(r=>`- ${r.action.toUpperCase()}: $${r.amount_usd} - ${r.description}`).join(`
`)}

详细日志请查看浏览器控制台
      `;q.success({title:"Cleanup Completed",content:v("pre",{style:"white-space: pre-wrap; font-family: monospace; font-size: 12px;"},a),width:700,okText:"Great!",onOk:()=>{d.info('建议点击 "Debug Subscription" 查看清理后的状态')}})}}catch(e){console.error("清理 pending items 失败:",e),d.error("Cleanup failed: "+e.message)}},resetCustomerBalance:async()=>{try{console.log("=== 开始重置客户余额 ==="),q.confirm({title:"Reset Customer Balance",content:"This will reset your Stripe customer balance to $0.00. This should fix the incorrect billing amount. Are you sure?",okText:"Yes, Reset",cancelText:"Cancel",onOk:async()=>{try{const e=await y.resetCustomerBalance();if(console.log("=== 重置结果 ==="),console.log(JSON.stringify(e,null,2)),e!=null&&e.data){const n=e.data,a=`
重置客户余额结果:

${n.message}

详细信息:
- 之前余额: $${n.previous_balance_usd}
- 当前余额: $${n.current_balance_usd}
- 调整金额: $${n.adjustment_amount_usd}
- 交易ID: ${n.transaction_id}

现在请点击 "Debug Subscription" 查看更新后的状态
下期账单应该显示正常的 $998.00
            `;q.success({title:"Balance Reset Completed",content:v("pre",{style:"white-space: pre-wrap; font-family: monospace; font-size: 12px;"},a),width:600,okText:"Perfect!",onOk:()=>{d.info('建议点击 "Debug Subscription" 查看余额重置后的状态')}})}}catch(e){console.error("重置余额失败:",e),d.error("Reset failed: "+e.message)}}})}catch(e){console.error("重置客户余额失败:",e),d.error("Reset failed: "+e.message)}},ref:b,computed:x,watch:Ge,h:v,onMounted:ze,get useRouter(){return Le},get useI18n(){return Ee},get storeToRefs(){return Ae},get useUserStore(){return Ve},get membershipService(){return y},get message(){return d},get Modal(){return q},get CheckOutlined(){return pt},get GiftOutlined(){return ye},get StripeLogo(){return vt},get WechatLogo(){return gt},get userService(){return qe}};return Object.defineProperty(Ue,"__isScriptSetup",{enumerable:!1,value:!0}),Ue}},ht={class:"pricing-page"},wt={class:"header"},Pt={key:0,class:"title"},Ct={class:"billing-toggle"},St={key:0,class:"downgrade-notice"},Dt={class:"downgrade-notice-content"},kt={class:"downgrade-text"},Mt={class:"pricing-cards"},Ot={key:0,class:"pricing-cards-container"},Ut={class:"pricing-card"},It={class:"info"},Tt={class:"plan-name"},Nt={key:0,class:"price"},xt={key:1,class:"price"},Ft={style:{display:"flex","flex-direction":"column"}},Bt={key:0,class:"save-text"},Rt={key:0,class:"monthly-equivalent"},Et={key:2,class:"benefits-list"},Lt={class:"benefit-item-icon"},At={class:"benefit-item-title"},zt={class:"qr-code-container"},Gt={style:{display:"flex","flex-direction":"column",gap:"16px",padding:"12px 4px"}},Vt={class:"payment-content"},qt={class:"payment-title"},Wt={class:"payment-description"},Yt={class:"payment-content"},jt={class:"payment-title"},Ht={class:"payment-description"},Jt={class:"cancel-btn"},Qt={key:0},Xt={key:0,class:"upgrade-preview-content"},Zt={class:"upgrade-info"},Kt={class:"upgrade-details"},$t={class:"upgrade-row"},en={class:"upgrade-row"},tn={class:"pricing-info"},nn={class:"pricing-details"},rn={class:"pricing-row"},an={class:"amount"};function on(i,u,M,t,F,se){var j;const m=dt,Y=mt,D=ft,B=q;return w(),S(ve,null,[s("div",ht,[s("div",wt,[M.showTitle==!0?(w(),S("h1",Pt,o(i.$t("member.pricing")),1)):h("v-if",!0),s("div",Ct,[T(m,{value:t.billingType,"onUpdate:value":u[0]||(u[0]=l=>t.billingType=l),options:t.billingOptions,size:"large"},null,8,["value"])])]),h(" 降级提示信息 "),t.isDowngradeStatus?(w(),S("div",St,[s("div",Dt,[s("span",kt,o(i.$t("member.downgradeNotice").replace("{planName}",(j=t.membership)==null?void 0:j.planName).replace("{targetPlan}",t.downgradeTargetPlan).replace("{date}",t.formatPeriodEndDate)),1),T(Y,{type:"primary",onClick:t.cancelDowngrade,loading:t.cancelDowngradeLoading},{default:V(()=>[$(o(i.$t("member.cancelDowngrade")),1)]),_:1},8,["loading"])])])):h("v-if",!0),s("div",Mt,[t.filteredPlans.length?(w(),S("div",Ot,[(w(!0),S(ve,null,Re(t.filteredPlans,l=>{var P;return w(),S("div",{key:l.id},[s("div",Ut,[s("div",It,[s("h3",Tt,o(l.plan_name),1),t.billingType==="month"?(w(),S("div",Nt,o(t.currency)+o(t.formatPrice(t.displayedPrices[l.id]??l.price))+" "+o(i.$t("member.monthlyBilling")),1)):(w(),S("div",xt,[s("div",Ft,[s("span",null,o(t.currency)+o(t.formatPrice(t.displayedPrices[l.id]))+" "+o(i.$t("member.monthlyBilling")),1),t.calculateYearlySavings(l)>0?(w(),S("span",Bt,o(i.$t("member.save"))+" "+o(t.currency)+o(t.calculateYearlySavings(l)),1)):h("v-if",!0)]),t.calculateYearlySavings(l)>0?(w(),S("div",Rt,o(t.currency)+o(l.price)+" "+o(i.$t("member.yearlyBilling")),1)):h("v-if",!0)])),(P=l.benefits)!=null&&P.length?(w(),S("div",Et,[(w(!0),S(ve,null,Re(l.benefits,(L,N)=>(w(),S("div",{key:N,class:"benefit-item"},[s("div",Lt,[L.iconType=="GiftOutlined"?(w(),be(t.GiftOutlined,{key:0})):(w(),be(t.CheckOutlined,{key:1}))]),s("div",At,o(L.title),1)]))),128))])):h("v-if",!0)]),T(Y,{loading:t.loadingMap[l.id],class:"subscribe-btn",size:"large",disabled:t.planDisabled(l),block:"",onClick:L=>t.pay(l)},{default:V(()=>[$(o(t.getPlanActionLabel(l)),1)]),_:2},1032,["loading","disabled","onClick"])])])}),128))])):h("v-if",!0)])]),T(B,{open:t.showQrCode,"onUpdate:open":u[1]||(u[1]=l=>t.showQrCode=l),centered:"",footer:null},{default:V(()=>[s("div",zt,[T(D,{value:t.qrCodeUrl,size:200},null,8,["value"]),s("p",null,o(i.$t("member.qrTip")),1)])]),_:1},8,["open"]),T(B,{open:t.showPaymentMethodModal,"onUpdate:open":u[4]||(u[4]=l=>t.showPaymentMethodModal=l),footer:null,centered:"",width:"480px",title:i.$t("member.selectPaymentMethod")},{default:V(()=>[s("div",Gt,[h(" Stripe "),s("div",{class:"payment-option",onClick:u[2]||(u[2]=l=>{var P;return t.handlePayment("stripe",(P=t.selectedPlan)==null?void 0:P.id)})},[T(t.StripeLogo),s("div",Vt,[s("div",qt,o(i.$t("payment.stripe.title")),1),s("div",Wt,o(i.$t("payment.stripe.description")),1)])]),h(" WeChat "),s("div",{class:"payment-option",onClick:u[3]||(u[3]=l=>{var P;return t.handlePayment("wechat",(P=t.selectedPlan)==null?void 0:P.id)})},[T(t.WechatLogo),s("div",Yt,[s("div",jt,o(i.$t("payment.wechat.title")),1),s("div",Ht,o(i.$t("payment.wechat.description")),1)])])])]),_:1},8,["open","title"]),s("div",Jt,[t.membership&&t.membership.subscription_id&&!t.isDowngradeStatus&&!t.cancelStatus?(w(),be(Y,{key:0,type:"text",onClick:t.openCancelMembership},{default:V(()=>[$(o(i.$t("member.cancelMembership")),1)]),_:1})):h("v-if",!0),h(" 调试按钮，仅在开发环境显示 "),h(` <a-button type="text" @click="debugSubscription" v-if="membership && membership.subscription_id" style="color: #ff4d4f; margin-left: 16px;">
      Debug Subscription
    </a-button> `),h(" 清理按钮 "),h(` <a-button type="text" @click="cleanupPendingItems" v-if="membership && membership.subscription_id" style="color: #52c41a; margin-left: 16px;">
      Cleanup Pending Items
    </a-button> `),h(" 重置余额按钮 "),h(` <a-button type="text" @click="resetCustomerBalance" v-if="membership && membership.subscription_id" style="color: #722ed1; margin-left: 16px;">
      Reset Balance
    </a-button> `)]),T(B,{open:t.showCancelConfirm,"onUpdate:open":u[5]||(u[5]=l=>t.showCancelConfirm=l),title:i.$t("member.confirmCancelTitle"),onOk:t.handleConfirmCancel,onCancel:u[6]||(u[6]=l=>t.showCancelConfirm=!1),"ok-button-props":{loading:t.confirmLoading},"ok-text":i.$t("member.confirm"),"cancel-text":i.$t("member.cancel")},{default:V(()=>[s("p",null,o(i.$t("member.confirmCancelMessage")),1)]),_:1},8,["open","title","ok-button-props","ok-text","cancel-text"]),T(B,{open:t.showDowngradeConfirm,"onUpdate:open":u[7]||(u[7]=l=>t.showDowngradeConfirm=l),title:i.$t("member.confirmDowngrade"),onOk:t.handleConfirmDowngrade,onCancel:u[8]||(u[8]=l=>t.showDowngradeConfirm=!1),"ok-button-props":{loading:t.confirmLoading},"ok-text":i.$t("member.confirmDowngrade"),"cancel-text":i.$t("member.cancel")},{default:V(()=>{var l;return[t.pendingDowngradePlan?(w(),S("p",Qt,[$(o(i.$t("member.confirmDowngradeMessage"))+" "+o((l=t.membership)==null?void 0:l.planName)+" "+o(i.$t("member.to"))+" "+o(t.pendingDowngradePlan.plan_name)+"? ",1),u[10]||(u[10]=s("br",null,null,-1)),u[11]||(u[11]=s("br",null,null,-1)),$(" "+o(i.$t("member.effectAtPeriodEnd"))+" ("+o(t.formatPeriodEndDate)+"). ",1)])):h("v-if",!0)]}),_:1},8,["open","title","ok-button-props","ok-text","cancel-text"]),h(" 升级预览确认弹窗 "),T(B,{open:t.showUpgradeConfirm,"onUpdate:open":u[9]||(u[9]=l=>t.showUpgradeConfirm=l),title:i.$t("member.upgradePreviewTitle"),width:"520px",centered:"",onOk:t.handleConfirmUpgrade,onCancel:t.cancelUpgradePreview,"ok-button-props":{loading:t.confirmLoading},"ok-text":i.$t("member.confirmUpgrade"),"cancel-text":i.$t("member.cancel")},{default:V(()=>{var l,P,L,N,p;return[t.upgradePreview?(w(),S("div",Xt,[s("div",Zt,[s("h4",null,o(i.$t("member.upgradeSummary")),1),s("div",Kt,[s("div",$t,[s("span",null,o(i.$t("member.from")),1),s("strong",null,o((l=t.membership)==null?void 0:l.planName)+" - "+o(t.currency)+o(t.formatPrice(t.getCurrentPlanPrice()))+"/"+o(((P=t.membership)==null?void 0:P.durationDays)===365?i.$t("member.year"):i.$t("member.month")),1)]),s("div",en,[s("span",null,o(i.$t("member.to")),1),s("strong",null,o((L=t.pendingUpgradePlan)==null?void 0:L.plan_name)+" - "+o(t.currency)+o(t.formatPrice((N=t.pendingUpgradePlan)==null?void 0:N.price))+"/"+o(((p=t.pendingUpgradePlan)==null?void 0:p.duration_days)===365?i.$t("member.year"):i.$t("member.month")),1)])])]),s("div",tn,[s("h4",null,o(i.$t("member.paymentRequired")),1),s("div",nn,[s("div",rn,[s("span",null,o(i.$t("member.upgradePrice")),1),s("span",an,o(t.upgradePreview.currency==="USD"?"$":t.upgradePreview.currency)+o(t.formatPrice(t.upgradePreview.upgrade_price)),1)])])])])):h("v-if",!0)]}),_:1},8,["open","title","ok-button-props","ok-text","cancel-text"])],64)}const gn=ut(_t,[["render",on],["__scopeId","data-v-7b66bacd"],["__file","/Users/samihalawa/git/PROJECTS_CODING/lemonai/frontend/src/view/pay/components/pricing.vue"]]);export{gn as P};
